<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>
<body>
    微信授权测试
    <input type="button" onclick="getOpenid()" value="获取Openid">
    <script>
        $(function(){
            var wxopenid = getcookie('wxopenid');
            var access_code = GetQueryString('code');
            alert("wxopenid: "+wxopenid);
            alert("access_code: "+access_code);
            if(wxopenid == "" || wxopenid == undefined){
                alert(1);
                if(access_code == null){
                    alert(2);
                    var fromurl = encodeURIComponent(location.href);
                    var url='https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx22ae3075d64a4f81&redirect_uri='+fromurl+'&response_type=code&scope=snsapi_base&state=STATE%23wechat_redirect&connect_redirect=1#wechat_redirect';
                    window.location.href=url;
                }else {
                    alert(3);
                    $.ajax({
                        type:'get',
                        url:'http://www.meirenguvip.com/wxcs/service/oauth2_access_token',
                        data:{code:access_code},
                        success:function(result){
                            alert(result.openid);
                            if (result!=null){
                                //alert(result);
                                alert(result.openid);
                                addcookie('wxopenid',result.openid,360000);
                            }else {
                                alert('微信身份识别失败 \n '+result);
                                location.href=fromurl;
                            }
                        },
                        error: function(e) {
                            alert(JSON.stringify(e));
                        }
                    });
                }
            }
        });

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)
                return unescape(r[2]);
            return null;
        }

        function addcookie(name,value,expireHours){
            var cookieString=name+"="+escape(value)+"; path=/";
            //判断是否设置过期时间
            if(expireHours>0){
                var date=new Date();
                date.setTime(date.getTime+expireHours*3600*1000);
                cookieString=cookieString+"; expire="+date.toGMTString();
            }
            document.cookie=cookieString;
        }

        function getcookie(name){
            var strcookie=document.cookie;
            var arrcookie=strcookie.split("; ");
            for(var i=0;i<arrcookie.length;i++){
                var arr=arrcookie[i].split("=");
                if(arr[0]==name)return decodeURIComponent(arr[1]); //增加对特殊字符的解析
            }
            return "";
        }

        function delCookie(name){//删除cookie
            var exp = new Date();
            exp.setTime(exp.getTime() - 1);
            var cval=getcookie(name);
            if(cval!=null) document.cookie= name + "="+cval+"; path=/;expires="+exp.toGMTString();
        }

        function getOpenid(){
            alert("getOpenid: "+getcookie('wxopenid'));
        }
    </script>
</body>
</html>